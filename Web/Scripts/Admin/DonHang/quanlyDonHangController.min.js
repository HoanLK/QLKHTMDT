admin.controller("quanlyDonHangController",["$scope","$http","$cookies","$window","$location",function(n,t,i,r){function l(){var i=angular.element("#idUser").val();t.get("/API/AccountAPI/"+i).then(function(i){n.currentUser={Id:i.data.Id,UserName:i.data.UserName,Email:i.data.Email,TenNguoiDung:i.data.TenNguoiDung,PhoneNumber:i.data.PhoneNumber,DonVi_ID:i.data.DonVi_ID,Fax:i.data.Fax,KhachHang_ID:i.data.KhachHang_ID,PhoneNumber:i.data.PhoneNumber};t.get("/Account/GetRoleByAccount/"+n.currentUser.Id).then(function(t){n.currentUser.Role=t.data;switch(n.currentUser.Role){case"khachhang":r.location.href="/DonHang/ChotDonHang";break;case"nhanvienbuudien":r.location.href="/DonHang/XacNhanDonHang"}f();a();c();v()},function(){toastr.error("Không lấy được quyền Người dùng")})},function(){toastr.error("Không lấy được thông tin Người dùng")})}function f(){t.get("/API/DonHangAPI?att=NhanVien&&value="+n.currentUser.Id+"&&status="+n.filterDonHang.TrangThai).then(function(t){n.donhangs=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách đơn hàng")})}function h(i){t.get("/KhoSo/GetSoHieuChuaCapByDichVu/"+i).then(function(t){t.data!=null&&t.data!=""?n.donhang.SoHieu=t.data.SoHieu:(n.donhang.SoHieu="",alert("Kho số đã hết vui lòng liên hệ với quản lý Bưu điện"))},function(){n.donhang.SoHieu="";toastr.error("Không lấy được Số hiệu")})}function c(){t.get("/LoaiHang/GetListName").then(function(t){n.loaihangs=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách Loại hàng")})}function a(){t.get(e).then(function(t){n.tinhthanhphos=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách Tỉnh - Thành phố")})}function v(){t.get(o).then(function(t){n.dichvus=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách dịch vụ")})}var u,e,o,s;n.currentUser={};n.donhangs=[];n.donhang={};n.selectedDonHangs=[];n.filterDonHang={TrangThai:"CHUACHOT"};u="/API/DonHangAPI";n.tinhthanhphos=[];e="/API/TinhThanhPhoAPI";n.loaihangs=[];n.dichvus=[];n.dichvu={};o="/API/DichVuAPI";n.trangthaiChotDons=[{value:"CHUACHOT",text:"Chưa chốt"},{value:"DACHOT",text:"Đã chốt"}];n.postDonHang=!1;n.modifyDonHang=!1;n.titlePopupModifyDonHang="Thêm đơn hàng";n.popupModifyDonHang={width:"auto",height:"auto",contentTemplate:"templateModifyDonHang",showTitle:!0,resizeEnabled:!0,bindingOptions:{title:"titlePopupModifyDonHang",visible:"modifyDonHang"}};n.controlModifyDonHang={soHieu:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"donhang.SoHieu"},readOnly:!0},nguoiNhan:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"donhang.NguoiNhan"}},diachiNguoiNhan:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"donhang.DiaChiNguoiNhan"}},sdtNguoiNhan:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"donhang.SoDienThoaiNguoiNhan"}},noidungHang:{showClearButton:!0,valueChangeEvent:"keyup",bindingOptions:{value:"donhang.NoiDungHang"}},soluong:{showSpinButtons:!0,showClearButton:!0,min:0,invalidValueMesseage:"Vui lòng nhập số",bindingOptions:{value:"donhang.SoLuong"}},thoigianTaoDonHang:{type:"datetime",applyButtonText:"Xong",cancelButtonText:"Hủy",displayFormat:"dd/MM/yyyy HH:mm",readOnly:!0,bindingOptions:{value:"donhang.ThoiGianTaoDonHang"}},ngay:{type:"date",displayFormat:"dd/MM/yyyy",bindingOptions:{value:"donhang.Ngay"}},tinhthanhpho:{displayExpr:"TinhThanhPho_Name",valueExpr:"TinhThanhPho_ID",searchEnabled:!0,noDataText:"Không có dữ liệu",placeholder:"Chọn ...",bindingOptions:{items:"tinhthanhphos",value:"donhang.TinhThanhPho_ID"}},dichvu:{displayExpr:"DichVu_Name",valueExpr:"DichVu_ID",searchEnabled:!0,noDataText:"Không có dữ liệu",placeholder:"Chọn ...",bindingOptions:{items:"dichvus",value:"donhang.DichVu_ID",disabled:"!postDonHang"},onSelectionChanged:function(t){n.postDonHang==!0&&(n.donhang.DichVu_ID=t.selectedItem.DichVu_ID,h(n.donhang.DichVu_ID))}},loaiHang:{placeholder:"Loại hàng ...",bindingOptions:{dataSource:"loaihangs",value:"donhang.LoaiHang_Name"}}};n.deleteDonHang=!1;n.titleDeleteDonHang="Bạn có chắc chắn muốn xóa?";n.popupDeleteDonHang={width:"auto",height:"auto",contentTemplate:"templateDeleteDonHang",showTitle:!1,bindingOptions:{visible:"deleteDonHang"}};n.gridDonHangs={bindingOptions:{dataSource:"donhangs","columns[4].lookup.dataSource":"tinhthanhphos","columns[9].lookup.dataSource":"trangthaiChotDons","columns[10].lookup.dataSource":"dichvus"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!0,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columns:[{alignment:"left",allowEditing:!1,caption:"Số hiệu",dataField:"SoHieu",dataType:"string"},{alignment:"left",caption:"Người nhận",dataField:"NguoiNhan",dataType:"string"},{alignment:"left",caption:"SĐT người nhận",dataField:"SoDienThoaiNguoiNhan",dataType:"string"},{alignment:"left",caption:"Địa chỉ người nhận",dataField:"DiaChiNguoiNhan",dataType:"string"},{caption:"Tỉnh - Thành phố",dataField:"TinhThanhPho_ID",lookup:{displayExpr:"TinhThanhPho_Name",valueExpr:"TinhThanhPho_ID"}},{alignment:"right",caption:"Số tiền thu hộ",dataField:"SoTienThuHo",format:{type:"fixedPoint",precision:0}},{alignment:"left",caption:"Nội dung hàng",dataField:"LoaiHang_Name",dataType:"string"},{alignment:"right",caption:"Số lượng",dataField:"SoLuong",format:{type:"fixedPoint",precision:0}},{alignment:"left",caption:"Thời gian tạo đơn",dataField:"ThoiGianTaoDonHang",dataType:"date",format:"dd/MM/yyyy HH:mm",customizeText:function(n){return n.valueText}},{caption:"Trạng thái",dataField:"TrangThai",lookup:{displayExpr:"text",valueExpr:"value"},allowFiltering:!1},{caption:"Dịch vụ",dataField:"DichVu_ID",lookup:{displayExpr:"DichVu_Name",valueExpr:"DichVu_ID"}},],columnResizingMode:"widget",editing:{mode:"cell",allowAdding:!1,allowDeleting:!1,allowUpdating:!1,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!0,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Danh sách Đơn hàng",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!0},grouping:{contextMenuEnabled:!0,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Kéo một cột vào đây để nhóm theo cột đó",visible:!1},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!0},hoverStateEnabled:!0,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!0},paging:{enabled:!0,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"onClick"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{texts:{count:"{0}",sum:"{0}"},groupItems:[{column:"SoHieu",summaryType:"count"}],totalItems:[{column:"SoHieu",summaryType:"count"}]},wordWrapEnabled:!1,onToolbarPreparing:function(t){var i=t.component;t.toolbarOptions.items.unshift({location:"before",widget:"dxSelectBox",options:{width:200,items:[{value:"ALL",text:"Tất cả"},{value:"CHUACHOT",text:"Chưa chốt"},{value:"DACHOT",text:"Đã chốt"}],displayExpr:"text",valueExpr:"value",bindingOptions:{value:"filterDonHang.TrangThai"},onValueChanged:function(){f()}}},{location:"after",widget:"dxButton",options:{hint:"Thêm",icon:"add",type:"success",onClick:function(){n.AddDonHang()}}},{location:"after",widget:"dxButton",options:{hint:"Sửa",icon:"edit",type:"default",onClick:function(){n.EditDonHang()}}},{location:"after",widget:"dxButton",options:{hint:"Xóa",icon:"trash",type:"danger",onClick:function(){n.DeleteDonHang()}}},{location:"after",widget:"dxButton",options:{hint:"Load lại Dữ liệu",icon:"refresh",onClick:function(){f()}}})},onRowClick:function(t){var i=t.component;i.clickCount=i.clickCount?i.clickCount+1:1;i.clickCount==1?(i.lastClickTime=new Date,setTimeout(function(){i.lastClickTime=0;i.clickCount=0},350)):i.clickCount==2&&(new Date-i.lastClickTime<300&&(n.donhang=angular.copy(t.data),n.EditDonHang()),i.clickCount=0,i.lastClickTime=0)},onSelectionChanged:function(t){n.selectedDonHangs=angular.copy(t.selectedRowsData)}};s=[{value:"add",text:" Thêm",icon:"fa fa-plus"},{value:"edit",text:" Sửa",icon:"fa fa-pencil"},{value:"delete",text:" Xóa",icon:"fa fa-times"}];n.contextMenuDonHangs={dataSource:s,width:100,target:"#donhang",itemTemplate:function(n){var t=$("<div><\/div>");return n.icon&&t.append('<span class="'+n.icon+'"><span>'),t.append(n.text),t},onItemClick:function(t){if(!t.itemData.items)switch(t.itemData.value){case"add":n.AddDonHang();break;case"edit":n.EditDonHang();break;case"delete":n.DeleteDonHang()}}};l();n.AddDonHang=function(){n.donhang={DichVu_ID:"E",Ngay:new Date,ThoiGianTaoDonHang:new Date,TrangThai:"CHUACHOT",KhachHang_ID:n.currentUser.KhachHang_ID,NhanVien_ID:n.currentUser.Id,SoLuong:1,SoTienThuHo:0};h(n.donhang.DichVu_ID);c();n.modifyDonHang=!0;n.postDonHang=!0};n.EditDonHang=function(){n.selectedDonHangs.length==0?toastr.error("Chọn 1 dòng để sửa"):(n.donhang=angular.copy(n.selectedDonHangs[0]),n.donhang.TrangThai=="DACHOT"?toastr.error("Đơn hàng ĐÃ CHỐT"):(n.controlModifyDonHang.dichvu.disabled=!0,n.titlePopupModifyDonHang="Sửa đơn hàng",n.modifyDonHang=!0))};n.SaveDonHang=function(){n.postDonHang==!0?(n.donhang.Ngay.setTime(n.donhang.Ngay.getTime()+252e5),n.donhang.ThoiGianTaoDonHang.setTime(n.donhang.ThoiGianTaoDonHang.getTime()+252e5),t.post(u,n.donhang).then(function(i){t.get(u+"/"+i.data.SoHieu).then(function(t){n.donhangs.unshift(t.data);toastr.success("Thành công","Thêm");n.modifyDonHang=!1;n.postDonHang=!1},function(){toastr.error("Thất bại","Thêm")})},function(){toastr.error("Thất bại","Thêm")})):t.put(u+"/"+n.donhang.SoHieu,n.donhang).then(function(){angular.forEach(n.donhangs,function(t,i){t.SoHieu==n.donhang.SoHieu&&(n.donhangs[i]=angular.copy(n.donhang),toastr.success("Thành công","Sửa"),n.modifyDonHang=!1)})},function(){toastr.error("Thất bại","Sửa")})};n.CancelSaveDonHang=function(){n.modifyDonHang=!1};n.DeleteDonHang=function(){if(n.selectedDonHangs.length==0)toastr.error("Chọn dòng để xóa");else{var t=!0;angular.forEach(n.selectedDonHangs,function(n){n.TrangThai=="DACHOT"&&(t=!1)});t==!0?n.deleteDonHang=!0:toastr.error("Có đơn hàng ĐÃ CHỐT")}};n.ConfirmDeleteDonHang=function(){var i="";angular.forEach(n.selectedDonHangs,function(n){i+=n.SoHieu+","});t.get("/DonHang/XoaDonHang/"+i).then(function(n){n.data==1?(toastr.success("Xóa thành công"),f()):toastr.error("Xóa không thành công")},function(){toastr.error("Xóa không thành công")});n.deleteDonHang=!1};n.CancelDeleteDonHang=function(){n.deleteDonHang=!1}}]);