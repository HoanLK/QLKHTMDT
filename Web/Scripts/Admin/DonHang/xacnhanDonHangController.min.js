admin.controller("xacnhanDonHangController",["$scope","$http","$cookies","$window","$location",function(n,t,i,r){function s(){var i=angular.element("#idUser").val();t.get("/API/AccountAPI/"+i).then(function(i){n.currentUser={Id:i.data.Id,UserName:i.data.UserName,Email:i.data.Email,TenNguoiDung:i.data.TenNguoiDung,PhoneNumber:i.data.PhoneNumber,DonVi_ID:i.data.DonVi_ID,Fax:i.data.Fax,KhachHang_ID:i.data.KhachHang_ID,PhoneNumber:i.data.PhoneNumber};t.get("/Account/GetRoleByAccount/"+n.currentUser.Id).then(function(t){n.currentUser.Role=t.data;switch(n.currentUser.Role){case"khachhang":r.location.href="/DonHang/ChotDonHang";break;case"nhanvien":r.location.href="/DonHang/QuanLyDonHang"}u();h();c()},function(){toastr.error("Không lấy được quyền ChotDonHang")})},function(){toastr.error("Không lấy được thông tin ChotDonHang")})}function u(){t.get("/API/ChotDonHangAPI?att=DaChotTheoDonVi&&value="+n.currentUser.DonVi_ID).then(function(t){n.chotDonHangs=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách đơn hàng")})}function h(){t.get(f).then(function(t){n.tinhthanhphos=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách Tỉnh - Thành phố")})}function c(){t.get(e+"?att=DonVi&&value="+n.currentUser.DonVi_ID).then(function(t){n.khachhangs=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách Khách hàng")})}function l(){t.get("/APi/DonHangAPI?att=KhachHang&&value="+n.chotDonHang.KhachHang_ID+"&&status=ChuaChot").then(function(t){n.donhangChuaChots=angular.copy(t.data)},function(){toastr.error("Không lấy được đơn chưa chốt")})}function a(){t.get("/DonHang/GetChiTietByPhieuChotForExport/"+n.chotDonHang.ChotDonHang_ID).then(function(t){n.donhangChots=angular.copy(t.data);v()},function(){toastr.error("Không lấy được chi tiết phiếu chốt")})}function v(){t.get("/Account/GetNhanVienChotDonByKhachHang/"+n.chotDonHang.KhachHang_ID).then(function(t){n.nhanviens=angular.copy(t.data)},function(){toastr.error("Không lấy được danh sách Nhân viên")})}var o,f,e;n.currentUser={};n.chotDonHangs=[];n.chotDonHang={};n.selectedChotDonHangs=[];o="/API/ChotDonHangAPI";n.donhangChuaChots=[];n.donhangChuaChot={};n.selectedDonHangChuaChots=[];n.donhangChots=[];n.donhangChot={};n.selectedDonHangChots=[];n.tinhthanhphos=[];f="/API/TinhThanhPhoAPI";n.khachhangs=[];e="/API/KhachHangAPI";n.nhanviens=[];n.trangthaiChotDons=[{value:"CHUACHOT",text:"Chưa chốt"},{value:"DACHOT",text:"Đã chốt"}];n.trangthaiXacNhanDons=[{value:"CHUAXACNHAN",text:"Chưa xác nhận"},{value:"DAXACNHAN",text:"Đã xác nhận"}];n.postChotDonHang=!1;n.modifyChotDonHang=!1;n.titlePopupModifyChotDonHang="Chi tiết chốt đơn hàng";n.popupModifyChotDonHang={width:"auto",height:"auto",contentTemplate:"templateModifyChotDonHang",showTitle:!0,resizeEnabled:!0,fullScreen:!0,bindingOptions:{title:"titlePopupModifyChotDonHang",visible:"modifyChotDonHang"}};n.controlModifyChotDonHang={thoigianChotDonHang:{type:"datetime",applyButtonText:"Xong",cancelButtonText:"Hủy",displayFormat:"dd/MM/yyyy HH:mm",bindingOptions:{value:"chotDonHang.ThoiGianChotDonHang"}},thoigianXacNhanDonHang:{type:"datetime",applyButtonText:"Xong",cancelButtonText:"Hủy",displayFormat:"dd/MM/yyyy HH:mm",bindingOptions:{value:"chotDonHang.ThoiGianXacNhanDonHang"}},ngay:{type:"date",displayFormat:"dd/MM/yyyy",bindingOptions:{value:"chotDonHang.Ngay"}},trangthaiChotDon:{displayExpr:"text",valueExpr:"value",searchEnabled:!0,noDataText:"Không có dữ liệu",placeholder:"Chọn ...",bindingOptions:{items:"trangthaiChotDons",value:"chotDonHang.TrangThaiChotDonHang"}},trangthaiXacNhanDon:{displayExpr:"text",valueExpr:"value",searchEnabled:!0,noDataText:"Không có dữ liệu",placeholder:"Chọn ...",bindingOptions:{items:"trangthaiXacNhanDons",value:"chotDonHang.TrangThaiXacNhanDonHang"}}};n.deleteChotDonHang=!1;n.titleDeleteChotDonHang="Bạn có chắc chắn muốn xóa?";n.popupDeleteChotDonHang={width:"auto",height:"auto",contentTemplate:"templateDeleteChotDonHang",showTitle:!1,bindingOptions:{visible:"deleteChotDonHang"}};n.xacnhanDonHang=!1;n.titleXacNhanDonHang="Bạn có chắc chắn muốn XÁC NHẬN?";n.popupXacNhanDonHang={width:"auto",height:"auto",contentTemplate:"templateXacNhanDonHang",showTitle:!1,bindingOptions:{visible:"xacnhanDonHang"}};n.huyXacNhanDonHang=!1;n.titleHuyXacNhanDonHang="Bạn có chắc chắn muốn HỦY XÁC NHẬN?";n.popupHuyXacNhanDonHang={width:"auto",height:"auto",contentTemplate:"templateHuyXacNhanDonHang",showTitle:!1,bindingOptions:{visible:"huyXacNhanDonHang"}};n.gridChotDonHangs={bindingOptions:{dataSource:"chotDonHangs","columns[1].lookup.dataSource":"khachhangs","columns[3].lookup.dataSource":"trangthaiXacNhanDons"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!0,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columns:[{alignment:"left",allowEditing:!1,caption:"ID",dataField:"ChotDonHang_ID",dataType:"string"},{caption:"Khách hàng",dataField:"KhachHang_ID",lookup:{displayExpr:"KhachHang_Name",valueExpr:"KhachHang_ID"},allowFiltering:!1},{alignment:"left",caption:"Thời gian chốt đơn",dataField:"ThoiGianChotDonHang",dataType:"date",format:"dd/MM/yyyy HH:mm",customizeText:function(n){return n.valueText}},{caption:"Trạng thái xác nhận",dataField:"TrangThaiXacNhanDonHang",lookup:{displayExpr:"text",valueExpr:"value"},allowFiltering:!1},{alignment:"left",caption:"Thời gian xác nhận",dataField:"ThoiGianXacNhanDonHang",dataType:"date",format:"dd/MM/yyyy HH:mm",customizeText:function(n){return n.valueText}},],columnResizingMode:"widget",editing:{mode:"cell",allowAdding:!1,allowDeleting:!1,allowUpdating:!1,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!0,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Danh sách Chốt đơn",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!0},grouping:{contextMenuEnabled:!0,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Kéo một cột vào đây để nhóm theo cột đó",visible:!1},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!0},hoverStateEnabled:!0,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!0},paging:{enabled:!0,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"onClick"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{texts:{count:"{0}",sum:"{0}"},groupItems:[{column:"ChotDonHang_ID",summaryType:"count"}],totalItems:[{column:"ChotDonHang_ID",summaryType:"count"}]},wordWrapEnabled:!1,onToolbarPreparing:function(t){var i=t.component;t.toolbarOptions.items.unshift({location:"after",widget:"dxButton",options:{hint:"Xác nhận",icon:"check",type:"success",onClick:function(){n.XacNhanDonHang()}}},{location:"after",widget:"dxButton",options:{hint:"Hủy xác nhận",icon:"clear",type:"danger",onClick:function(){n.HuyXacNhanDonHang()}}},{location:"after",widget:"dxButton",options:{hint:"Load lại Dữ liệu",icon:"refresh",onClick:function(){u()}}})},onRowClick:function(t){var i=t.component;i.clickCount=i.clickCount?i.clickCount+1:1;i.clickCount==1?(i.lastClickTime=new Date,setTimeout(function(){i.lastClickTime=0;i.clickCount=0},350)):i.clickCount==2&&(new Date-i.lastClickTime<300&&(n.chotDonHang=angular.copy(t.data),n.EditChotDonHang()),i.clickCount=0,i.lastClickTime=0)},onSelectionChanged:function(t){n.selectedChotDonHangs=angular.copy(t.selectedRowsData)}};n.gridDonHangChots={bindingOptions:{dataSource:"donhangChots"},allowColumnResizing:!0,columnAutoWidth:!0,columnChooser:{emptyPanelText:"Kéo và thả cột muốn ẩn vào đây",enabled:!0,mode:"select",title:"Lựa chọn cột"},columnFixing:{enabled:!0,texts:{fix:"Cố định cột",leftPosition:"Bên trái",rightPosition:"Bên phải",unfix:"Hủy cố định"}},columnResizingMode:"widget",editing:{mode:"cell",allowAdding:!1,allowDeleting:!1,allowUpdating:!1,texts:{addRow:"Thêm",cancelAllChanges:"Không thay đổi",cancelRowChanges:"Hủy",confirmDeleteMessage:"Bạn có chắc chắn muốn xóa?",deleteRow:"Xóa",editRow:"Sửa",saveAllChanges:"Lưu thay đổi",saveRowChanges:"Lưu",undeleteRow:"Không xóa",validationCancelChanges:"Hủy thay đổi"}},"export":{allowExportSelectedData:!0,enabled:!0,excelFilterEnabled:!0,excelWrapTextEnabled:!0,fileName:"Đơn hàng đã chốt",texts:{exportAll:"Xuất toàn bộ Dữ liệu",exportSelectedRows:"Xuất dữ liệu đang chọn",exportTo:"Trích xuất"}},filterRow:{applyFilterText:"Áp dụng bộ lọc",betweenEndText:"Kết thúc",betweenStartText:"Bắt đầu",resetOperationText:"Thiết lập lại",showAllText:"(Tất cả)",visible:!0},grouping:{contextMenuEnabled:!0,expandMode:"rowClick",texts:{groupByThisColumn:"Nhóm theo Cột này",groupContinuedMessage:"Tiếp tục từ trang trước",groupContinuesMessage:"Tiếp tục trên các trang tiếp theo",ungroup:"Bỏ nhóm",ungroupAll:"Bỏ tất cả nhóm"}},groupPanel:{emptyPanelText:"Đơn hàng chưa chốt",visible:!0},headerFilter:{texts:{cancel:"Hủy",emptyValue:"(Trống)",ok:"Đồng ý"},visible:!0},hoverStateEnabled:!0,loadPanel:{enabled:!0,text:"Đang tải ..."},noDataText:"Không có dữ liệu",pager:{infoText:"Trang {0} của {1}",showInfo:!0,showNavigationButtons:!0,showPageSizeSelector:!0,visible:!0},paging:{enabled:!0,pageIndex:0,pageSize:50},remoteOperations:{grouping:!1,summary:!1},rowAlternationEnabled:!1,scrolling:{preloadEnabled:!0},searchPanel:{placeholder:"Tìm kiếm ..."},selection:{mode:"multiple",showCheckBoxesMode:"onClick"},showBorders:!0,showRowLines:!0,sorting:{ascendingText:"Sắp xếp Tăng dần",clearText:"Xóa Sắp xếp",descendingText:"Sắp xếp Giảm dần"},summary:{},wordWrapEnabled:!1};s();n.EditChotDonHang=function(){n.selectedChotDonHangs.length==0?toastr.error("Chọn 1 dòng để xem"):(n.chotDonHang=angular.copy(n.selectedChotDonHangs[0]),l(),a(),n.titlePopupModifyChotDonHang="Thông tin phiếu chốt đơn hàng",n.modifyChotDonHang=!0)};n.XacNhanDonHang=function(){n.selectedChotDonHangs.length==0?toastr.error("Chọn dòng để XÁC NHẬN"):n.xacnhanDonHang=!0};n.ConfirmXacNhanDonHang=function(){var i="";angular.forEach(n.selectedChotDonHangs,function(n){i+=n.ChotDonHang_ID+","});t.get("/DonHang/XacNhanChotDonHang/"+i).then(function(t){t.data==1?(toastr.success("XÁC NHẬN thành công"),u(),n.modifyChotDonHang=!1):toastr.error("XÁC NHẬN không thành công")},function(){toastr.error("XÁC NHẬN không thành công")});n.xacnhanDonHang=!1};n.CancelXacNhanDonHang=function(){n.xacnhanDonHang=!1};n.HuyXacNhanDonHang=function(){n.selectedChotDonHangs.length==0?toastr.error("Chọn dòng để HỦY XÁC NHẬN"):n.huyXacNhanDonHang=!0};n.ConfirmHuyXacNhanDonHang=function(){var i="";angular.forEach(n.selectedChotDonHangs,function(n){i+=n.ChotDonHang_ID+","});t.get("/DonHang/HuyXacNhanChotDonHang/"+i).then(function(t){t.data==1?(toastr.success("HỦY XÁC NHẬN thành công"),u(),n.modifyChotDonHang=!1):toastr.error("HỦY XÁC NHẬN không thành công")},function(){toastr.error("HỦY XÁC NHẬN không thành công")});n.huyXacNhanDonHang=!1};n.CancelHuyXacNhanDonHang=function(){n.huyXacNhanDonHang=!1}}]);